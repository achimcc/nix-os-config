# CVE Monitoring für NixOS-Pakete
# Nutzt vulnix um bekannte CVEs in installierten Paketen zu finden
{ config, pkgs, ... }:

{
  # Vulnix für CVE-Scanning
  environment.systemPackages = with pkgs; [
    vulnix
  ];

  # Täglicher CVE-Scan
  systemd.services.cve-scan = {
    description = "CVE Vulnerability Scan";
    serviceConfig = {
      Type = "oneshot";
      User = "root";
      ExecStart = pkgs.writeShellScript "cve-scan" ''
        #!/usr/bin/env bash
        set -euo pipefail

        REPORT="/var/log/cve-scan/$(date +%Y-%m-%d).log"
        mkdir -p "$(dirname "$REPORT")"

        echo "=== CVE Scan Report: $(date) ===" > "$REPORT"
        echo "" >> "$REPORT"

        # Scanne System-Profile auf Vulnerabilities
        ${pkgs.vulnix}/bin/vulnix --system 2>&1 | tee -a "$REPORT" || true

        # Zähle gefundene CVEs
        CVE_COUNT=$(grep -c "CVE-" "$REPORT" || echo "0")

        if [ "$CVE_COUNT" -gt 0 ]; then
          # Bei gefundenen CVEs: Desktop-Benachrichtigung
          ${pkgs.libnotify}/bin/notify-send \
            --urgency=critical \
            --icon=dialog-warning \
            "CVE Scan: $CVE_COUNT Vulnerabilities gefunden" \
            "Details in $REPORT"

          # Email-Benachrichtigung via posteo-mailer
          echo "Subject: [NixOS Security] CVE Scan: $CVE_COUNT Vulnerabilities

CVE Scan hat $CVE_COUNT bekannte Vulnerabilities gefunden.

Report: $REPORT

$(tail -50 "$REPORT")
" | ${pkgs.msmtp}/bin/msmtp ${config.sops.placeholder."email/posteo"}
        else
          echo "Keine CVEs gefunden ✓" >> "$REPORT"
        fi

        # Alte Reports aufräumen (>30 Tage)
        find /var/log/cve-scan -name "*.log" -mtime +30 -delete
      '';
    };
  };

  systemd.timers.cve-scan = {
    description = "Daily CVE Vulnerability Scan";
    wantedBy = [ "timers.target" ];
    timerConfig = {
      OnCalendar = "daily";
      RandomizedDelaySec = "1h";
      Persistent = true;
    };
  };

  # Log-Verzeichnis erstellen
  systemd.tmpfiles.rules = [
    "d /var/log/cve-scan 0755 root root 30d"
  ];
}
